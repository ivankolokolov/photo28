{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 1.5rem;
        color: white;
        text-align: center;
    }
    
    .stat-card.green {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .stat-card.orange {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .stat-card.blue {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .stat-sublabel {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    .section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #333;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .two-columns {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }
    
    .progress-bar {
        background: #e9ecef;
        border-radius: 4px;
        height: 24px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        padding-left: 8px;
        color: white;
        font-size: 0.8rem;
        font-weight: 500;
        min-width: fit-content;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 0.25rem;
    }
    
    .customer-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }
    
    .customer-row:last-child {
        border-bottom: none;
    }
    
    .customer-name {
        font-weight: 500;
    }
    
    .customer-stats {
        text-align: right;
        font-size: 0.9rem;
    }
    
    .customer-spent {
        font-weight: 600;
        color: #28a745;
    }
    
    .customer-orders {
        color: #666;
        font-size: 0.8rem;
    }
    
    .metric-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .metric-row:last-child {
        border-bottom: none;
    }
    
    .metric-label {
        color: #666;
    }
    
    .metric-value {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1>

<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ "{:,}".format(summary.revenue.today).replace(",", " ") }}‚ÇΩ</div>
        <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
        <div class="stat-sublabel">{{ summary.revenue.today_orders }} –∑–∞–∫–∞–∑–æ–≤</div>
    </div>
    <div class="stat-card green">
        <div class="stat-value">{{ "{:,}".format(summary.revenue.week).replace(",", " ") }}‚ÇΩ</div>
        <div class="stat-label">–ó–∞ –Ω–µ–¥–µ–ª—é</div>
        <div class="stat-sublabel">{{ summary.revenue.week_orders }} –∑–∞–∫–∞–∑–æ–≤</div>
    </div>
    <div class="stat-card orange">
        <div class="stat-value">{{ "{:,}".format(summary.revenue.month).replace(",", " ") }}‚ÇΩ</div>
        <div class="stat-label">–ó–∞ –º–µ—Å—è—Ü</div>
        <div class="stat-sublabel">{{ summary.revenue.month_orders }} –∑–∞–∫–∞–∑–æ–≤</div>
    </div>
    <div class="stat-card blue">
        <div class="stat-value">{{ summary.revenue.avg_check }}‚ÇΩ</div>
        <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</div>
        <div class="stat-sublabel">–∑–∞ 30 –¥–Ω–µ–π</div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏ -->
<div class="section">
    <div class="section-title">üìà –í—ã—Ä—É—á–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</div>
    <div class="chart-container">
        <canvas id="revenueChart"></canvas>
    </div>
</div>

<div class="two-columns">
    <!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã -->
    <div class="section">
        <div class="section-title">üì∑ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã</div>
        {% for item in format_stats %}
        <div style="margin-bottom: 1rem;">
            <div class="progress-label">
                <span>{{ item.format_name }}</span>
                <span>{{ item.count }} —à—Ç. ({{ item.percent }}%)</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ item.percent }}%;">
                    {% if item.percent > 10 %}{{ item.count }}{% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <p style="color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
        {% endfor %}
    </div>
    
    <!-- –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏ -->
    <div class="section">
        <div class="section-title">üöö –°–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏</div>
        {% for item in delivery_stats %}
        <div style="margin-bottom: 1rem;">
            <div class="progress-label">
                <span>{{ item.delivery_name }}</span>
                <span>{{ item.count }} ({{ item.percent }}%)</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ item.percent }}%; background: linear-gradient(90deg, #11998e, #38ef7d);">
                    {% if item.percent > 10 %}{{ item.count }}{% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <p style="color: #999;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
        {% endfor %}
    </div>
</div>

<div class="two-columns">
    <!-- –ö–æ–Ω–≤–µ—Ä—Å–∏—è -->
    <div class="section">
        <div class="section-title">üìä –ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        <div class="metric-row">
            <span class="metric-label">–í—Å–µ–≥–æ –Ω–∞—á–∞—Ç–æ –∑–∞–∫–∞–∑–æ–≤</span>
            <span class="metric-value">{{ summary.conversion.total_started }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">–û–ø–ª–∞—á–µ–Ω–æ</span>
            <span class="metric-value" style="color: #28a745;">{{ summary.conversion.total_paid }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">–ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∏</span>
            <span class="metric-value" style="color: #ffc107;">{{ summary.conversion.total_drafts }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
            <span class="metric-value" style="color: #dc3545;">{{ summary.conversion.total_cancelled }}</span>
        </div>
        <div class="metric-row" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee;">
            <span class="metric-label"><strong>–ö–æ–Ω–≤–µ—Ä—Å–∏—è</strong></span>
            <span class="metric-value" style="font-size: 1.2rem;">{{ summary.conversion.conversion_rate }}%</span>
        </div>
    </div>
    
    <!-- –ö–ª–∏–µ–Ω—Ç—ã -->
    <div class="section">
        <div class="section-title">üë• –ö–ª–∏–µ–Ω—Ç—ã</div>
        <div class="metric-row">
            <span class="metric-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
            <span class="metric-value">{{ customer_stats.total_users }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">–° –∑–∞–∫–∞–∑–∞–º–∏</span>
            <span class="metric-value">{{ customer_stats.users_with_orders }}</span>
        </div>
        <div class="metric-row">
            <span class="metric-label">–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</span>
            <span class="metric-value" style="color: #28a745;">{{ customer_stats.repeat_customers }}</span>
        </div>
        <div class="metric-row" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #eee;">
            <span class="metric-label"><strong>% –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö</strong></span>
            <span class="metric-value" style="font-size: 1.2rem;">{{ customer_stats.repeat_rate }}%</span>
        </div>
    </div>
</div>

<!-- –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
<div class="section">
    <div class="section-title">üèÜ –¢–æ–ø –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
    {% for customer in top_customers %}
    <div class="customer-row">
        <div class="customer-name">
            {{ loop.index }}. 
            {% if customer.username %}
            <a href="https://t.me/{{ customer.username }}" target="_blank">{{ customer.name }}</a>
            {% else %}
            {{ customer.name }}
            {% endif %}
        </div>
        <div class="customer-stats">
            <div class="customer-spent">{{ "{:,}".format(customer.total_spent).replace(",", " ") }}‚ÇΩ</div>
            <div class="customer-orders">{{ customer.orders_count }} –∑–∞–∫–∞–∑–æ–≤</div>
        </div>
    </div>
    {% else %}
    <p style="color: #999;">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö</p>
    {% endfor %}
</div>

<script>
// –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏
const ctx = document.getElementById('revenueChart').getContext('2d');
const chartData = {{ chart_data | tojson }};

new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
        }),
        datasets: [{
            label: '–í—ã—Ä—É—á–∫–∞',
            data: chartData.map(d => d.revenue),
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            fill: true,
            tension: 0.4,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.parsed.y.toLocaleString('ru-RU') + '‚ÇΩ';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return value.toLocaleString('ru-RU') + '‚ÇΩ';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

