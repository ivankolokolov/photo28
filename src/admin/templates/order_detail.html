{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑ #{{ order.order_number }} ‚Äî Photo28 Admin{% endblock %}

{% block content %}
<div style="margin-bottom: 1.5rem;">
    <a href="/orders" style="color: var(--text-muted); text-decoration: none;">‚Üê –ù–∞–∑–∞–¥ –∫ –∑–∞–∫–∞–∑–∞–º</a>
</div>

<div class="card">
    <div class="order-header">
        <div>
            <h1 class="order-number">–ó–∞–∫–∞–∑ #{{ order.order_number }}</h1>
            <span class="badge badge-{{ order.status.value }}" style="margin-top: 0.5rem;">{{ order.status.display_name }}</span>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="/orders/{{ order.id }}/download" class="btn btn-secondary btn-sm">üì• –°–∫–∞—á–∞—Ç—å —Ñ–æ—Ç–æ</a>
            <form method="post" action="/orders/{{ order.id }}/upload-yandex" style="display: inline;">
                <button type="submit" class="btn btn-secondary btn-sm">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ –Ø.–î–∏—Å–∫</button>
            </form>
            <a href="/orders/{{ order.id }}/photos" class="btn btn-secondary btn-sm">üñº –ü—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ</a>
        </div>
    </div>
    
    <div class="order-meta">
        <div class="meta-item">
            <span class="meta-label">–ö–ª–∏–µ–Ω—Ç</span>
            <span class="meta-value">{{ order.user.display_name if order.user else '‚Äî' }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Telegram</span>
            <span class="meta-value">
                {% if order.user and order.user.username %}
                <a href="https://t.me/{{ order.user.username }}" target="_blank" style="color: var(--accent);">@{{ order.user.username }}</a>
                {% else %}
                ID: {{ order.user.telegram_id if order.user else '‚Äî' }}
                {% endif %}
            </span>
        </div>
        <div class="meta-item">
            <span class="meta-label">–°–æ–∑–¥–∞–Ω</span>
            <span class="meta-value">{{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        {% if order.paid_at %}
        <div class="meta-item">
            <span class="meta-label">–û–ø–ª–∞—á–µ–Ω</span>
            <span class="meta-value">{{ order.paid_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">üì∑ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</h2>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>–§–æ—Ä–º–∞—Ç</th>
                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
            </tr>
        </thead>
        <tbody>
            {% for product_id, count in order.photos_by_product().items() %}
            {% set product = ProductService.get_product(product_id) %}
            <tr>
                <td>{{ product.short_name if product else '–¢–æ–≤–∞—Ä #' ~ product_id }}</td>
                <td>{{ count }} —à—Ç.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td><strong>–í—Å–µ–≥–æ</strong></td>
                <td><strong>{{ order.photos_count }} —à—Ç.</strong></td>
            </tr>
        </tfoot>
    </table>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">üöö –î–æ—Å—Ç–∞–≤–∫–∞</h2>
    </div>
    
    <div class="order-meta">
        <div class="meta-item">
            <span class="meta-label">–°–ø–æ—Å–æ–±</span>
            <span class="meta-value">{{ order.delivery_type.display_name if order.delivery_type else '–ù–µ –≤—ã–±—Ä–∞–Ω' }}</span>
        </div>
        {% if order.delivery_city %}
        <div class="meta-item">
            <span class="meta-label">–ì–æ—Ä–æ–¥</span>
            <span class="meta-value">{{ order.delivery_city }}</span>
        </div>
        {% endif %}
        {% if order.delivery_address %}
        <div class="meta-item">
            <span class="meta-label">–ê–¥—Ä–µ—Å</span>
            <span class="meta-value">{{ order.delivery_address }}</span>
        </div>
        {% endif %}
        {% if order.delivery_phone %}
        <div class="meta-item">
            <span class="meta-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
            <span class="meta-value">{{ order.delivery_phone }}</span>
        </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å</h2>
    </div>
    
    <div class="order-meta">
        <div class="meta-item">
            <span class="meta-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</span>
            <span class="meta-value">{{ order.photos_cost }}‚ÇΩ</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">–î–æ—Å—Ç–∞–≤–∫–∞</span>
            <span class="meta-value">{{ order.delivery_cost }}‚ÇΩ</span>
        </div>
        {% if order.discount > 0 %}
        <div class="meta-item">
            <span class="meta-label">–°–∫–∏–¥–∫–∞</span>
            <span class="meta-value" style="color: var(--success);">-{{ order.discount }}‚ÇΩ</span>
        </div>
        {% endif %}
        <div class="meta-item">
            <span class="meta-label">–ò—Ç–æ–≥–æ</span>
            <span class="meta-value" style="font-size: 1.5rem; color: var(--accent);">{{ order.total_cost }}‚ÇΩ</span>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">‚öôÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h2>
    </div>
    
    <form method="post" action="/orders/{{ order.id }}/status" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <select name="status" class="form-select" style="width: auto; min-width: 200px;">
            {% for status in statuses %}
            {% if status.value != 'draft' %}
            <option value="{{ status.value }}" {% if order.status == status %}selected{% endif %}>
                {{ status.display_name }}
            </option>
            {% endif %}
            {% endfor %}
        </select>
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" name="notify_client" value="true" checked>
            <span>üì≤ –£–≤–µ–¥–æ–º–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</span>
        </label>
        <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </form>
</div>
{% endblock %}

