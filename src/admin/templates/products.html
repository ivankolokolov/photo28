{% extends "base.html" %}

{% block title %}–¢–æ–≤–∞—Ä—ã ‚Äî Photo28 Admin{% endblock %}

{% block content %}
<style>
    .tier-row { display: flex; gap: 8px; align-items: center; margin-bottom: 6px; }
    .tier-row input { flex: 1; padding: 7px; background: #111; border: 1px solid #333; border-radius: 6px; color: #eee; box-sizing: border-box; font-size: 13px; }
    .tier-btn { padding: 6px 10px; border-radius: 6px; cursor: pointer; font-size: 13px; border: 1px solid #333; }
    .tier-btn-add { background: #1a3a1a; color: #4CAF50; border-color: #2d5a2d; }
    .tier-btn-del { background: #3a1a1a; color: #f44336; border-color: #5a2a2a; min-width: 32px; }
    .field-label { display: block; color: #888; font-size: 13px; margin-bottom: 4px; }
    .field-hint { color: #666; font-size: 11px; margin-top: 2px; }
    .field-input { width: 100%; padding: 8px; background: #111; border: 1px solid #333; border-radius: 6px; color: #eee; box-sizing: border-box; }
    .field-select { width: 100%; padding: 8px; background: #111; border: 1px solid #333; border-radius: 6px; color: #eee; }
    .field-group { margin-bottom: 12px; }
    .field-row { display: flex; gap: 12px; margin-bottom: 12px; }
    .field-row > div { flex: 1; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a2e; border: 1px solid #333; border-radius: 12px; padding: 24px; max-width: 520px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-close { background: none; border: none; color: #888; cursor: pointer; font-size: 20px; }
    .tiers-section { background: #111; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .tiers-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .tiers-header span { color: #888; font-size: 13px; }
    .price-type-hint { padding: 8px 12px; background: #111; border-radius: 6px; color: #666; font-size: 12px; margin-bottom: 12px; border: 1px solid #222; }
    .table-cell { padding: 10px 8px; }
    .table-cell-actions { padding: 10px 8px; white-space: nowrap; }
    .action-btn { border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; border: 1px solid #444; display: inline-block; }
</style>

<div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1>üè∑ –¢–æ–≤–∞—Ä—ã –∏ —Ñ–æ—Ä–º–∞—Ç—ã</h1>
    <button onclick="document.getElementById('addModal').style.display='flex'" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
    </button>
</div>

{% if saved %}
<div style="background: #1a3a1a; border: 1px solid #2d5a2d; border-radius: 8px; padding: 12px 16px; margin-bottom: 20px; color: #4CAF50;">
    ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞.
</div>
{% endif %}

<div style="background: #1a1a2e; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 24px; color: #888; font-size: 13px;">
    üí° <b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</b> = —Ç–æ–≤–∞—Ä –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ (–Ω–∞–ø—Ä. –ü–æ–ª–∞—Ä–æ–∏–¥ ‚Üí –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π, –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π).
    <b>–¶–µ–Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</b> ‚Äî —Ç–æ–≤–∞—Ä—ã –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –¥–ª—è —Å–∫–∏–¥–∫–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞.
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div style="overflow-x: auto;">
<table style="width: 100%; border-collapse: collapse;">
    <thead>
        <tr style="border-bottom: 2px solid #333; color: #888; font-size: 13px; text-align: left;">
            <th class="table-cell">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th class="table-cell">–¶–µ–Ω–∞</th>
            <th class="table-cell">–°–∫–∏–¥–∫–∞ –æ—Ç –∫–æ–ª-–≤–∞</th>
            <th class="table-cell">–ì—Ä—É–ø–ø–∞</th>
            <th class="table-cell">–°—Ç–∞—Ç—É—Å</th>
            <th class="table-cell">–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for product in products %}
        <tr style="border-bottom: 1px solid #222; background: {% if not product.is_active %}#1a1a1a{% else %}transparent{% endif %};">
            <td class="table-cell" style="font-weight: 600;">
                {{ product.emoji }} {{ product.name }}
                {% if children_map.get(product.id) %}
                    <span style="color: #666; font-size: 11px; display: block;">–∫–∞—Ç–µ–≥–æ—Ä–∏—è</span>
                {% endif %}
            </td>
            <td class="table-cell">
                {% if product.price_per_unit > 0 %}
                    <b>{{ product.price_per_unit }}‚ÇΩ</b>/—à—Ç
                {% else %}
                    <span style="color: #666;">‚Äî</span>
                {% endif %}
            </td>
            <td class="table-cell" style="font-size: 12px; color: #888;">
                {% if product.price_tiers %}
                    {% for tier in product.get_price_tiers() %}
                        –æ—Ç {{ tier.min_qty }} —à—Ç ‚Üí {{ tier.price }}‚ÇΩ{% if not loop.last %}, {% endif %}
                    {% endfor %}
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td class="table-cell" style="color: #888; font-size: 12px;">{{ product.pricing_group or '‚Äî' }}</td>
            <td class="table-cell">
                {% if product.is_active %}
                    <span style="color: #4CAF50;">‚úÖ –í–∫–ª</span>
                {% else %}
                    <span style="color: #f44336;">‚ùå –í—ã–∫–ª</span>
                {% endif %}
            </td>
            <td class="table-cell-actions">
                <button onclick='openEditModal({{ product.id }}, {{ product | tojson }})' class="action-btn" style="background: #1a3a5e; color: #4da6ff; border-color: #2a4a7e;">‚úèÔ∏è</button>
                <form method="POST" action="/products/{{ product.id }}/toggle" style="display: inline;">
                    <button type="submit" class="action-btn" style="background: {% if product.is_active %}#3a3a1a{% else %}#1a3a1a{% endif %}; color: {% if product.is_active %}#ff9800{% else %}#4CAF50{% endif %};">
                        {% if product.is_active %}‚è∏{% else %}‚ñ∂Ô∏è{% endif %}
                    </button>
                </form>
                <form method="POST" action="/products/{{ product.id }}/delete" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å ¬´{{ product.name }}¬ª –∏ –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã?');">
                    <button type="submit" class="action-btn" style="background: #3a1a1a; color: #f44336; border-color: #5a2a2a;">üóë</button>
                </form>
            </td>
        </tr>
        
        {% if children_map.get(product.id) %}
            {% for child in children_map[product.id] %}
            <tr style="border-bottom: 1px solid #1a1a1a; background: {% if not child.is_active %}#1a1a1a{% else %}#111{% endif %};">
                <td class="table-cell" style="padding-left: 32px; color: #ccc;">
                    ‚îî {{ child.emoji }} {{ child.name }}
                </td>
                <td class="table-cell"><b>{{ child.price_per_unit }}‚ÇΩ</b>/—à—Ç</td>
                <td class="table-cell" style="font-size: 12px; color: #888;">
                    {% if child.price_tiers %}
                        {% for tier in child.get_price_tiers() %}
                            –æ—Ç {{ tier.min_qty }} —à—Ç ‚Üí {{ tier.price }}‚ÇΩ{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        ‚Äî
                    {% endif %}
                </td>
                <td class="table-cell" style="color: #666; font-size: 12px;">{{ child.pricing_group or '‚Äî' }}</td>
                <td class="table-cell">
                    {% if child.is_active %}<span style="color: #4CAF50;">‚úÖ</span>{% else %}<span style="color: #f44336;">‚ùå</span>{% endif %}
                </td>
                <td class="table-cell-actions">
                    <button onclick='openEditModal({{ child.id }}, {{ child | tojson }})' class="action-btn" style="background: #1a3a5e; color: #4da6ff; border-color: #2a4a7e;">‚úèÔ∏è</button>
                    <form method="POST" action="/products/{{ child.id }}/toggle" style="display: inline;">
                        <button type="submit" class="action-btn" style="background: {% if child.is_active %}#3a3a1a{% else %}#1a3a1a{% endif %}; color: {% if child.is_active %}#ff9800{% else %}#4CAF50{% endif %};">
                            {% if child.is_active %}‚è∏{% else %}‚ñ∂Ô∏è{% endif %}
                        </button>
                    </form>
                    <form method="POST" action="/products/{{ child.id }}/delete" style="display: inline;" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å ¬´{{ child.name }}¬ª?');">
                        <button type="submit" class="action-btn" style="background: #3a1a1a; color: #f44336; border-color: #5a2a2a;">üóë</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        {% endif %}
        {% endfor %}
    </tbody>
</table>
</div>

<!-- ===== –ú–æ–¥–∞–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ===== -->
<div id="addModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin: 0;">‚ûï –ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h2>
            <button onclick="document.getElementById('addModal').style.display='none'" class="modal-close">‚úï</button>
        </div>
        
        <form method="POST" action="/products" onsubmit="return prepareForm(this, 'add')">
            <div class="field-group">
                <label class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input name="name" required class="field-input" placeholder="–ü–æ–ª–∞—Ä–æ–∏–¥ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π">
            </div>
            <div class="field-group">
                <label class="field-label">–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                <input name="short_name" required class="field-input" placeholder="–ü–æ–ª–∞—Ä–æ–∏–¥ –≤–µ—Ä—Ç.">
            </div>
            <div class="field-group">
                <label class="field-label">Slug (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID)</label>
                <input name="slug" required class="field-input" placeholder="polaroid_vertical">
            </div>
            <div class="field-row">
                <div>
                    <label class="field-label">–≠–º–æ–¥–∑–∏</label>
                    <input name="emoji" value="üì∑" class="field-input">
                </div>
                <div>
                    <label class="field-label">–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
                    <input name="sort_order" type="number" value="0" class="field-input">
                </div>
            </div>
            <div class="field-group">
                <label class="field-label">–†–æ–¥–∏—Ç–µ–ª—å (–¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)</label>
                <select name="parent_id" class="field-select">
                    <option value="0">‚Äî –ù–µ—Ç (–≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å) ‚Äî</option>
                    {% for p in products %}
                    <option value="{{ p.id }}">{{ p.emoji }} {{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="field-group">
                <label class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea name="description" rows="2" class="field-input"></textarea>
            </div>
            <div class="field-row">
                <div>
                    <label class="field-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —à—Ç. (‚ÇΩ)</label>
                    <input name="price_per_unit" type="number" value="0" class="field-input">
                </div>
                <div>
                    <label class="field-label">–¢–∏–ø —Ü–µ–Ω—ã</label>
                    <select name="price_type" class="field-select" onchange="toggleTiers(this, 'add')">
                        <option value="per_unit">–ó–∞ —à—Ç—É–∫—É</option>
                        <option value="tiered">–°–æ —Å–∫–∏–¥–∫–æ–π –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</option>
                        <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
                    </select>
                </div>
            </div>

            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–∏—Ä–æ–≤ -->
            <div id="add_tiers_section" class="tiers-section" style="display: none;">
                <div class="tiers-header">
                    <span>üìä –°–∫–∏–¥–∫–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</span>
                    <button type="button" class="tier-btn tier-btn-add" onclick="addTierRow('add')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="add_tiers_list">
                    <div class="tier-row">
                        <span style="color: #888; font-size: 12px; white-space: nowrap;">–æ—Ç</span>
                        <input type="number" placeholder="50" class="tier-qty" min="1">
                        <span style="color: #888; font-size: 12px; white-space: nowrap;">—à—Ç ‚Üí</span>
                        <input type="number" placeholder="19" class="tier-price" min="1">
                        <span style="color: #888; font-size: 12px;">‚ÇΩ</span>
                        <button type="button" class="tier-btn tier-btn-del" onclick="this.closest('.tier-row').remove()">‚úï</button>
                    </div>
                </div>
                <div class="field-hint">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —Å–∫–∏–¥–∫—É, –∫–æ–≥–¥–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –ø–æ—Ä–æ–≥–∞</div>
            </div>
            <input type="hidden" name="price_tiers_json" id="add_tiers_json">

            <div class="field-row">
                <div>
                    <label class="field-label">–¶–µ–Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</label>
                    <input name="pricing_group" class="field-input" placeholder="polaroid">
                    <div class="field-hint">–¢–æ–≤–∞—Ä—ã –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –¥–ª—è —Å–∫–∏–¥–∫–∏</div>
                </div>
                <div>
                    <label class="field-label">Aspect ratio (–®/–í)</label>
                    <input name="aspect_ratio" type="number" step="0.001" class="field-input" placeholder="0.76">
                    <div class="field-hint">–î–ª—è –∫–∞–¥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–æ—Ç–æ</div>
                </div>
            </div>
            <button type="submit" style="width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä
            </button>
        </form>
    </div>
</div>

<!-- ===== –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ===== -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="margin: 0;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h2>
            <button onclick="document.getElementById('editModal').style.display='none'" class="modal-close">‚úï</button>
        </div>
        
        <form id="editForm" method="POST" action="" onsubmit="return prepareForm(this, 'edit')">
            <div class="field-group">
                <label class="field-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="edit_name" name="name" required class="field-input">
            </div>
            <div class="field-group">
                <label class="field-label">–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="edit_short_name" name="short_name" required class="field-input">
            </div>
            <div class="field-row">
                <div>
                    <label class="field-label">–≠–º–æ–¥–∑–∏</label>
                    <input id="edit_emoji" name="emoji" class="field-input">
                </div>
                <div>
                    <label class="field-label">–ü–æ—Ä—è–¥–æ–∫</label>
                    <input id="edit_sort_order" name="sort_order" type="number" class="field-input">
                </div>
            </div>
            <div class="field-group">
                <label class="field-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="edit_description" name="description" rows="2" class="field-input"></textarea>
            </div>
            <div class="field-row">
                <div>
                    <label class="field-label">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –∑–∞ —à—Ç. (‚ÇΩ)</label>
                    <input id="edit_price" name="price_per_unit" type="number" class="field-input">
                </div>
                <div>
                    <label class="field-label">–¢–∏–ø —Ü–µ–Ω—ã</label>
                    <select id="edit_price_type" name="price_type" class="field-select" onchange="toggleTiers(this, 'edit')">
                        <option value="per_unit">–ó–∞ —à—Ç—É–∫—É</option>
                        <option value="tiered">–°–æ —Å–∫–∏–¥–∫–æ–π –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</option>
                        <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è</option>
                    </select>
                </div>
            </div>

            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Ç–∏—Ä–æ–≤ -->
            <div id="edit_tiers_section" class="tiers-section" style="display: none;">
                <div class="tiers-header">
                    <span>üìä –°–∫–∏–¥–∫–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞</span>
                    <button type="button" class="tier-btn tier-btn-add" onclick="addTierRow('edit')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
                <div id="edit_tiers_list"></div>
                <div class="field-hint">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —Å–∫–∏–¥–∫—É, –∫–æ–≥–¥–∞ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –≥—Ä—É–ø–ø–µ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç –ø–æ—Ä–æ–≥–∞</div>
            </div>
            <input type="hidden" name="price_tiers_json" id="edit_tiers_json">

            <div class="field-row">
                <div>
                    <label class="field-label">–¶–µ–Ω–æ–≤–∞—è –≥—Ä—É–ø–ø–∞</label>
                    <input id="edit_group" name="pricing_group" class="field-input">
                    <div class="field-hint">–¢–æ–≤–∞—Ä—ã –≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–µ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –¥–ª—è —Å–∫–∏–¥–∫–∏</div>
                </div>
                <div>
                    <label class="field-label">Aspect ratio</label>
                    <input id="edit_ratio" name="aspect_ratio" type="number" step="0.001" class="field-input">
                </div>
            </div>
            <button type="submit" style="width: 100%; padding: 12px; background: #4da6ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
        </form>
    </div>
</div>

<script>
// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é —Ç–∏—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ü–µ–Ω—ã
function toggleTiers(selectEl, prefix) {
    const section = document.getElementById(prefix + '_tiers_section');
    section.style.display = selectEl.value === 'tiered' ? 'block' : 'none';
}

// –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Ç–∏—Ä–∞
function addTierRow(prefix, qty = '', price = '') {
    const list = document.getElementById(prefix + '_tiers_list');
    const row = document.createElement('div');
    row.className = 'tier-row';
    row.innerHTML = `
        <span style="color: #888; font-size: 12px; white-space: nowrap;">–æ—Ç</span>
        <input type="number" placeholder="50" class="tier-qty" min="1" value="${qty}">
        <span style="color: #888; font-size: 12px; white-space: nowrap;">—à—Ç ‚Üí</span>
        <input type="number" placeholder="19" class="tier-price" min="1" value="${price}">
        <span style="color: #888; font-size: 12px;">‚ÇΩ</span>
        <button type="button" class="tier-btn tier-btn-del" onclick="this.closest('.tier-row').remove()">‚úï</button>
    `;
    list.appendChild(row);
}

// –°–æ–±—Ä–∞—Ç—å —Ç–∏—Ä—ã –≤ JSON –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
function prepareForm(form, prefix) {
    const rows = document.querySelectorAll('#' + prefix + '_tiers_list .tier-row');
    const tiers = [];
    rows.forEach(row => {
        const qty = parseInt(row.querySelector('.tier-qty').value);
        const price = parseInt(row.querySelector('.tier-price').value);
        if (qty > 0 && price > 0) {
            tiers.push({ min_qty: qty, price: price });
        }
    });
    document.getElementById(prefix + '_tiers_json').value = tiers.length > 0 ? JSON.stringify(tiers) : '';
    return true;
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –¥–∞–Ω–Ω—ã–º–∏ —Ç–æ–≤–∞—Ä–∞
function openEditModal(id, product) {
    document.getElementById('editForm').action = '/products/' + id + '/update';
    document.getElementById('edit_name').value = product.name || '';
    document.getElementById('edit_short_name').value = product.short_name || '';
    document.getElementById('edit_emoji').value = product.emoji || 'üì∑';
    document.getElementById('edit_description').value = product.description || '';
    document.getElementById('edit_price').value = product.price_per_unit || 0;
    document.getElementById('edit_price_type').value = product.price_type || 'per_unit';
    document.getElementById('edit_group').value = product.pricing_group || '';
    document.getElementById('edit_ratio').value = product.aspect_ratio || '';
    document.getElementById('edit_sort_order').value = product.sort_order || 0;
    
    // –¢–∏—Ä—ã
    const tiersSection = document.getElementById('edit_tiers_section');
    const tiersList = document.getElementById('edit_tiers_list');
    tiersList.innerHTML = '';
    
    if (product.price_type === 'tiered') {
        tiersSection.style.display = 'block';
        let tiers = [];
        if (product.price_tiers) {
            try { tiers = JSON.parse(product.price_tiers); } catch(e) {}
        }
        if (tiers.length === 0) {
            addTierRow('edit');
        } else {
            tiers.forEach(t => addTierRow('edit', t.min_qty, t.price));
        }
    } else {
        tiersSection.style.display = 'none';
    }
    
    document.getElementById('editModal').style.display = 'flex';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ –ø–æ –∫–ª–∏–∫—É –Ω–∞ –æ–≤–µ—Ä–ª–µ–π
document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) this.style.display = 'none';
    });
});
</script>

{% endblock %}
